name: Build Add-ons

on:
  push:
    branches: [main]
    paths:
      - '**/config.yaml'
      - '**/Dockerfile'
      - '**/rootfs/**'
      - '**/build.yaml'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  init:
    name: Initialize build
    if: ${{ !contains(github.event.head_commit.message, '[nobuild]') && !contains(github.event.head_commit.message, '[skip ci]') }}
    runs-on: ubuntu-latest
    outputs:
      changed_addons: ${{ steps.changed_addons.outputs.addons }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed add-ons
        id: changed_addons
        run: |
          # Build all add-ons if workflow_dispatch or [build-all]
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || \
             [[ "${{ github.event.head_commit.message }}" == *"[build-all]"* ]]; then
            addons=$(find . -maxdepth 2 -name config.yaml ! -path "*/.common/*" ! -path "*/templates/*" -exec dirname {} \; | sed 's|^\./||' | jq -R -s -c 'split("\n")[:-1]')
            echo "addons=${addons}" >> $GITHUB_OUTPUT
            echo "Building all add-ons: ${addons}"
          else
            # Only build changed add-ons
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              COMPARE_FROM="${{ github.event.pull_request.base.sha }}"
            else
              COMPARE_FROM="${{ github.event.before }}"
            fi

            # Find directories with changed files
            changed=$(git diff --name-only "${COMPARE_FROM}" "${{ github.sha }}" | grep -E '^[^/]+/' | cut -d'/' -f1 | sort -u | \
                      xargs -I {} sh -c 'test -f {}/config.yaml && echo {}' || echo "")

            if [ -z "$changed" ]; then
              echo "addons=[]" >> $GITHUB_OUTPUT
              echo "No add-on changes detected"
            else
              addons=$(echo "$changed" | jq -R -s -c 'split("\n") | map(select(length > 0))')
              echo "addons=${addons}" >> $GITHUB_OUTPUT
              echo "Changed add-ons: ${addons}"
            fi
          fi

  build:
    name: Build ${{ matrix.addon }} (${{ matrix.arch }})
    needs: init
    if: needs.init.outputs.changed_addons != '[]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        addon: ${{ fromJson(needs.init.outputs.changed_addons) }}
        arch: [amd64, aarch64, armhf, armv7, i386]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get add-on information
        id: info
        run: |
          if [ ! -f "${{ matrix.addon }}/config.yaml" ]; then
            echo "Error: config.yaml not found in ${{ matrix.addon }}"
            exit 1
          fi

          VERSION=$(grep "^version:" ${{ matrix.addon }}/config.yaml | awk '{print $2}' | tr -d '"')
          SLUG=$(grep "^slug:" ${{ matrix.addon }}/config.yaml | awk '{print $2}' | tr -d '"')
          NAME=$(grep "^name:" ${{ matrix.addon }}/config.yaml | cut -d'"' -f2)

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "slug=${SLUG}" >> $GITHUB_OUTPUT
          echo "name=${NAME}" >> $GITHUB_OUTPUT

          echo "Building ${NAME} v${VERSION} (${SLUG}) for ${{ matrix.arch }}"

      - name: Check architecture support
        id: arch_check
        run: |
          if grep -A 10 "arch:" ${{ matrix.addon }}/config.yaml | grep -q "${{ matrix.arch }}"; then
            echo "supported=true" >> $GITHUB_OUTPUT
            echo "Architecture ${{ matrix.arch }} is supported"
          else
            echo "supported=false" >> $GITHUB_OUTPUT
            echo "Skipping unsupported architecture: ${{ matrix.arch }}"
          fi

      - name: Set up QEMU
        if: steps.arch_check.outputs.supported == 'true'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.arch_check.outputs.supported == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: steps.arch_check.outputs.supported == 'true' && github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build add-on
        if: steps.arch_check.outputs.supported == 'true'
        uses: home-assistant/builder@master
        with:
          args: |
            --${{ matrix.arch }} \
            --target ${{ matrix.addon }} \
            --docker-hub ${{ env.REGISTRY }}/${{ github.repository_owner }} \
            ${{ github.event_name != 'pull_request' && '--addon' || '--test' }}

      - name: Build success
        if: steps.arch_check.outputs.supported == 'true'
        run: |
          echo "âœ… Successfully built ${{ matrix.addon }} for ${{ matrix.arch }}"
